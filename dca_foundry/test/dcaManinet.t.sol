// SPDX-License-Identifier: MIT
pragma solidity 0.8.19;

import "forge-std/Test.sol";
import "forge-std/console.sol";
import "../src/DcaOperation.sol";

contract ContractTest is Test {
    DcaOperation public dca;

    //forge test --fork-url https://rpc.ankr.com/eth/12d247b0e33c7b6fe4c2043571ba62f08ea3dbf97a4e7e44cc568841c1f260c7 --match-path test/dcaManinet.t.sol --gas-report
    receive() external payable {}

    fallback() external payable {}

    function setUp() public {
        // mainnetFork = vm.createFork(MAINNET_RPC_URL);
        dca = new DcaOperation(
            0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2,
            0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419,
            0x84a0856b038eaAd1cC7E297cF34A7e72685A8693,
            95 * 10 ** 16
        );
    }

    // function testForUSDT() public {
    //     dca.addToken(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48);
    //     address[] memory allAddress = dca.getAllTokens();
    //     address a = allAddress[0];
    //     console.logAddress(a);
    //     deal(a, address(this), 1e4 * 1e6);
    //     console.log(IWETH(a).balanceOf(address(this)));
    //     IWETH(a).approve(address(dca), dca.MAX_INT());
    //     dca.depositFunds(
    //         1e4 * 1e6,
    //         10000,
    //         0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2,
    //         a,
    //         block.timestamp,
    //         block.timestamp + 1000000
    //     );
    //     dca.deleteSchedule(0);
    //     // uint256 Eth_usd = (uint256(dca.getLatestData()) *
    //     //     5 *
    //     //     1e15 *
    //     //     (10 ** (IWETH(a).decimals()))) / (1e18 * 1e8);
    //     // console.log(Eth_usd);
    //     // for (uint256 i = 0; i < 10; i++) {
    //     //     vm.warp(block.timestamp + 10000);
    //     //     bytes
    //     //         memory input = hex"90411a3200000000000000000000000023ebcd701fd92867235aeb0174b7c444b9b2b3ad000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000023ebcd701fd92867235aeb0174b7c444b9b2b3ad0000000000000000000000005615deb798bb3e4dfa0139dfa1b3d433cc23b72f00000000000000000000000000000000000000000000000000000000052d222e00000000000000000000000000000000000000000000000000ba6cb3bc4a8c2500000000000000000000000000000000000000000000000000bc4ec510f0cb9e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064eb5625d9000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000069d460e01070a7ba1bc363885bc8f4f0daa19bf500000000000000000000000000000000000000000000000000000000052d222e0000000000000000000000000000000000000000000000000000000000000000000000000000000069d460e01070a7ba1bc363885bc8f4f0daa19bf500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000a48201aa3f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000052d222e000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000648a6a1e85000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000353c1f0bc78fbbc245b3c93ef77b1dcc5b77d2a027100000000000000000000000000000000000000000000000bc4ec510f0cb9e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f865422000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f99000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000005615deb798bb3e4dfa0139dfa1b3d433cc23b72f00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    //     //     // console.logBytes(input);
    //     //     dca.runUserDCA(
    //     //         address(this),
    //     //         0,
    //     //         0x6352a56caadC4F1E25CD6c75970Fa768A3304e64,
    //     //         payable(0x6352a56caadC4F1E25CD6c75970Fa768A3304e64),
    //     //         input
    //     //     );
    //     //     console.log(IWETH(a).balanceOf(address(this)));
    //     //     console.log(IWETH(a).balanceOf(address(dca)));
    //     // }
    // }

    function testForETH() public {
        // vm.selectFork(mainnetFork);
        // assertEq(vm.activeFork(), mainnetFork);

        dca.addToken(dca.ETH());
        address[] memory allAddress = dca.getAllTokens();
        address a = allAddress[0];
        console.logAddress(a);
        console.log((address(dca)).balance);
        dca.depositFunds{value: 1e4 * 1e18}(
            1e4 * 1e18,
            100000,
            0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48,
            a,
            block.timestamp,
            block.timestamp + 1000000
        );
        // dca.deleteSchedule(0);
        for (uint256 i = 0; i < 10; i++) {
            vm.warp(block.timestamp + 100000);
            bytes
                memory input = hex"bc80f1a8000000000000000000000000bdfa4f4492dd7b7cf211209c4791af8d52bf5c500000000000000000000000000000000000000000000000007ce66c50e2840000000000000000000000000000000000000000000000000000000000034840d8180000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000180006400000000000000000088e6a0c2ddd26feeb64f039a2c41296fcb3f5640";
            // console.logBytes(input);
            dca.runUserDCA(
                address(this),
                0,
                0x6352a56caadC4F1E25CD6c75970Fa768A3304e64,
                payable(0x6352a56caadC4F1E25CD6c75970Fa768A3304e64),
                input
            );
            console.log(
                "--",
                IWETH(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48).balanceOf(
                    address(this)
                )
            );
            console.log("-", address(dca).balance);
        }
    }
}
