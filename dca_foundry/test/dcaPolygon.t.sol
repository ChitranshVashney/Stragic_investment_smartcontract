// SPDX-License-Identifier: MIT
pragma solidity 0.8.19;

import "forge-std/Test.sol";
import "forge-std/console.sol";
import "../src/DcaOperation.sol";

contract ContractTest is Test {
    DcaOperation public dca;

    //forge test --fork-url https://rpc.ankr.com/polygon/12d247b0e33c7b6fe4c2043571ba62f08ea3dbf97a4e7e44cc568841c1f260c7 --match-path test/dcaPolygon.t.sol --gas-report
    receive() external payable {}

    fallback() external payable {}

    function setUp() public {
        // mainnetFork = vm.createFork(MAINNET_RPC_URL);
        dca = new DcaOperation(
            0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270,
            0xAB594600376Ec9fD91F8e885dADF0CE036862dE0,
            0xf0511f123164602042ab2bCF02111fA5D3Fe97CD,
            10 ** 17
        );
    }

    // function testForUSDT() public {
    //     dca.addToken(0xc2132D05D31c914a87C6611C10748AEb04B58e8F);
    //     address[] memory allAddress = dca.getAllTokens();
    //     address a = allAddress[0];
    //     console.logAddress(a);
    //     deal(a, address(this), 1e4 * 1e6);
    //     console.log(IWETH(a).balanceOf(address(this)));
    //     IWETH(a).approve(address(dca), dca.MAX_INT());
    //     dca.depositFunds(
    //         1e4 * 1e6,
    //         10000,
    //         0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270,
    //         a,
    //         block.timestamp,
    //         block.timestamp + 1000000
    //     );
    //     dca.deleteSchedule(0);
    //     // uint256 Eth_usd = (uint256(dca.getLatestData()) *
    //     //     5 *
    //     //     1e15 *
    //     //     (10 ** (IWETH(a).decimals()))) / (1e18 * 1e8);
    //     // console.log(Eth_usd);
    //     // for (uint256 i = 0; i < 10; i++) {
    //     //     vm.warp(block.timestamp + 10000);
    //     //     bytes
    //     //         memory input = hex"90411a3200000000000000000000000023ebcd701fd92867235aeb0174b7c444b9b2b3ad000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000023ebcd701fd92867235aeb0174b7c444b9b2b3ad0000000000000000000000005615deb798bb3e4dfa0139dfa1b3d433cc23b72f00000000000000000000000000000000000000000000000000000000052d222e00000000000000000000000000000000000000000000000000ba6cb3bc4a8c2500000000000000000000000000000000000000000000000000bc4ec510f0cb9e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064eb5625d9000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000069d460e01070a7ba1bc363885bc8f4f0daa19bf500000000000000000000000000000000000000000000000000000000052d222e0000000000000000000000000000000000000000000000000000000000000000000000000000000069d460e01070a7ba1bc363885bc8f4f0daa19bf500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000a48201aa3f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000052d222e000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000648a6a1e85000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000353c1f0bc78fbbc245b3c93ef77b1dcc5b77d2a027100000000000000000000000000000000000000000000000bc4ec510f0cb9e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f865422000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f99000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000005615deb798bb3e4dfa0139dfa1b3d433cc23b72f00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    //     //     // console.logBytes(input);
    //     //     dca.runUserDCA(
    //     //         address(this),
    //     //         0,
    //     //         0x6352a56caadC4F1E25CD6c75970Fa768A3304e64,
    //     //         payable(0x6352a56caadC4F1E25CD6c75970Fa768A3304e64),
    //     //         input
    //     //     );
    //     //     console.log(IWETH(a).balanceOf(address(this)));
    //     //     console.log(IWETH(a).balanceOf(address(dca)));
    //     // }
    // }

    function testForETH() public {
        // vm.selectFork(mainnetFork);
        // assertEq(vm.activeFork(), mainnetFork);

        dca.addToken(dca.ETH());
        address[] memory allAddress = dca.getAllTokens();
        address a = allAddress[0];
        console.logAddress(address(dca));
        console.log("starting balace", address(dca).balance);
        dca.depositFunds{value: 1e2 * 1e18}(
            1e2 * 1e18,
            100000,
            0xc2132D05D31c914a87C6611C10748AEb04B58e8F,
            a,
            block.timestamp,
            block.timestamp + 1000000
        );
        // dca.deleteSchedule(0);
        for (uint256 i = 0; i < 10; i++) {
            vm.warp(block.timestamp + 100000);
            bytes
                memory input = hex"90411a320000000000000000000000001aa298ae7c53d8dafa200ed49608649bfa76a446000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f0000000000000000000000001aa298ae7c53d8dafa200ed49608649bfa76a4460000000000000000000000005615deb798bb3e4dfa0139dfa1b3d433cc23b72f00000000000000000000000000000000000000000000000088b23acffd99000000000000000000000000000000000000000000000000000000000000004f9a7d00000000000000000000000000000000000000000000000000000000005068540000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000104e5b07cdb000000000000000000000000b580229645b240a368768ec3e88cb67a41ebbc5b000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000088b23acffd9900000000000000000000000000001aa298ae7c53d8dafa200ed49608649bfa76a44600000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002e0d500b1d8e8ef31e21c99d1db9a6444d3adf12700001f4c2132d05d31c914a87c6611c10748aeb04b58e8f00000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000648a6a1e85000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f000000000000000000000000353c1f0bc78fbbc245b3c93ef77b1dcc5b77d2a0271000000000000000000000000000000000000000000000000000000050685400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f865422000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f00000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f99000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f0000000000000000000000005615deb798bb3e4dfa0139dfa1b3d433cc23b72f00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
            dca.runUserDCA(
                address(this),
                0,
                0x6352a56caadC4F1E25CD6c75970Fa768A3304e64,
                payable(0x6352a56caadC4F1E25CD6c75970Fa768A3304e64),
                input
            );
            console.log(
                "--",
                IWETH(0xc2132D05D31c914a87C6611C10748AEb04B58e8F).balanceOf(
                    address(this)
                )
            );
            console.log("-", address(dca).balance);
        }
    }
}
